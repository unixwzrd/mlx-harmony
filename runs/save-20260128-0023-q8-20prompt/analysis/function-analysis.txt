     4  module: src/mlx_harmony/__init__.py                                 (L1-L4)

   329  module: src/mlx_harmony/cache.py                                  (L1-L329)
   105    class: KVCache                                                 (L14-L118)
     4      def: __init__                                                 (L24-L27)
    40      def: update_and_fetch                                         (L29-L68)
     3      def: __len__                                                  (L70-L72)
     3      def: is_trimmable                                             (L74-L76)
    13      def: trim                                                     (L78-L90)
    11      def: state                                                   (L93-L103)
     9      def: state                                                  (L106-L114)
     3      def: __bool__                                               (L116-L118)
   187    class: RotatingKVCache                                        (L121-L307)
     7      def: __init__                                               (L131-L137)
     3      def: offset                                                 (L140-L142)
     2      def: offset                                                 (L145-L146)
     9      def: _trim                                                  (L148-L156)
    15      def: _temporal_order                                        (L158-L172)
    18      def: _update_concat                                         (L174-L191)
    41      def: _update_in_place                                       (L193-L233)
     4      def: update_and_fetch                                       (L235-L238)
     2      def: __len__                                                (L240-L241)
    25      def: make_mask                                              (L243-L267)
     2      def: is_trimmable                                           (L269-L270)
     5      def: trim                                                   (L272-L276)
    12      def: state                                                  (L279-L290)
    11      def: state                                                  (L293-L303)
     3      def: __bool__                                               (L305-L307)
    20    def: make_prompt_cache                                        (L310-L329)

   295  module: src/mlx_harmony/chat.py                                   (L1-L295)
    18    def: _collect_memory_stats                                      (L36-L53)
    13    class: MessageDict                                              (L57-L69)
   217    def: main                                                      (L75-L291)

   198  module: src/mlx_harmony/chat_adapters.py                          (L1-L198)
    37    class: ModelAdapter                                             (L12-L48)
    11      def: stream                                                   (L13-L23)
     7      def: decode_raw                                               (L25-L31)
    16      def: parse                                                    (L33-L48)
    77    class: HarmonyAdapter                                          (L51-L127)
    20      def: stream                                                   (L52-L71)
    13      def: decode_raw                                               (L73-L85)
    41      def: parse                                                   (L87-L127)
    63    class: NativeAdapter                                          (L130-L192)
    25      def: stream                                                 (L131-L155)
     4        def: handle_token                                         (L142-L145)
     8      def: decode_raw                                             (L157-L164)
    27      def: parse                                                  (L166-L192)
     4    def: get_adapter                                              (L195-L198)

   399  module: src/mlx_harmony/chat_attempt.py                           (L1-L399)
   197    def: run_generation_attempt                                    (L15-L211)
    47    def: _detect_text_repetition                                  (L214-L260)
     6    def: _metrics_timestamp                                       (L263-L268)
     5    def: _next_metrics_row_index                                  (L271-L275)
     6    def: _filter_repetition_tokens                                (L278-L283)
    19    def: _detect_token_repetition                                 (L286-L304)
    23    def: _looks_complete_response                                 (L307-L329)
    68    def: _write_attempt_artifacts                                 (L332-L399)

   162  module: src/mlx_harmony/chat_bootstrap.py                         (L1-L162)
    10    class: BootstrapResult                                          (L35-L44)
   116    def: bootstrap_chat                                            (L47-L162)

   186  module: src/mlx_harmony/chat_cli.py                               (L1-L186)
   181    def: build_parser                                               (L6-L186)

    31  module: src/mlx_harmony/chat_controller.py                         (L1-L31)

    93  module: src/mlx_harmony/chat_generation.py                         (L1-L93)
    84    def: stream_generation                                          (L10-L93)

   213  module: src/mlx_harmony/chat_harmony.py                           (L1-L213)
     5    def: _decode_tokens                                             (L15-L19)
     4    class: HarmonyParseResult                                       (L23-L26)
   185    def: parse_harmony_response                                    (L29-L213)

   560  module: src/mlx_harmony/chat_history.py                           (L1-L560)
     7    def: normalize_chat_name                                        (L15-L21)
    29    def: normalize_dir_path                                         (L24-L52)
     7    def: make_timestamp                                             (L55-L61)
     3    def: make_message_id                                            (L64-L66)
     3    def: make_chat_id                                               (L69-L71)
     6    def: find_last_hyperparameters                                  (L74-L79)
    13    def: ensure_message_links                                       (L82-L94)
    21    def: normalize_timestamp                                       (L97-L117)
    55    def: resolve_chat_paths                                       (L120-L174)
    12    def: resolve_debug_path                                       (L177-L188)
    11    def: resolve_dirs_from_config                                 (L191-L201)
    49    def: restore_chat_metadata                                    (L204-L252)
    13    def: _write_debug_block                                       (L255-L267)
    13    def: write_debug_prompt                                       (L270-L282)
    14    def: write_debug_response                                     (L285-L298)
    17    def: write_debug_token_texts                                  (L301-L317)
    84    def: load_chat_session                                        (L320-L403)
    31    def: write_debug_tokens                                       (L406-L436)
    18    def: write_debug_metrics                                      (L439-L456)
    22    def: _format_metrics_tsv                                      (L459-L480)
    24    def: _format_metrics_tsv_header                               (L483-L506)
     8    def: find_last_assistant_message                              (L509-L516)
    42    def: display_resume_message                                   (L519-L560)

   215  module: src/mlx_harmony/chat_io.py                                (L1-L215)
    12    def: _drain_pasted_lines                                        (L25-L36)
    16    def: read_user_input                                            (L39-L54)
     9    def: _read_multiline_block                                      (L57-L65)
    80    def: save_conversation                                         (L68-L147)
    35    def: load_conversation                                        (L150-L184)
    29    def: try_save_conversation                                    (L187-L215)

   294  module: src/mlx_harmony/chat_migration.py                         (L1-L294)
     2    def: _new_report                                                (L21-L22)
    63    def: _ensure_metadata_fields                                    (L25-L87)
    15    def: _normalize_chat_entry                                     (L90-L104)
    21    def: _migrate_v1_to_v2                                        (L107-L127)
    43    def: migrate_chat_data                                        (L130-L172)
    37    def: validate_chat_container                                  (L175-L211)
    33    def: build_chat_container                                     (L214-L246)
    46    def: main                                                     (L249-L294)

   164  module: src/mlx_harmony/chat_prompt.py                            (L1-L164)
    31    def: prepare_prompt                                             (L12-L42)
    19    def: build_prompt_token_ids                                     (L45-L63)
    99    def: truncate_conversation_for_context                         (L66-L164)

    93  module: src/mlx_harmony/chat_render.py                             (L1-L93)
    32    def: display_assistant                                          (L14-L45)
    24    def: display_thinking                                           (L48-L71)
    20    def: _render_markdown                                           (L74-L93)

   134  module: src/mlx_harmony/chat_retry.py                             (L1-L134)
    89    def: build_retry_plan                                            (L8-L96)
    36    def: apply_retry_to_conversation                               (L99-L134)

   239  module: src/mlx_harmony/chat_turn.py                              (L1-L239)
   223    def: run_chat_turn                                             (L17-L239)

    66  module: src/mlx_harmony/chat_types.py                              (L1-L66)
     5    class: ParsedOutput                                              (L8-L12)
     9    class: GenerationArtifacts                                      (L16-L24)
     3    class: RetryDecision                                            (L28-L30)
     5    class: RetryPlan                                                (L34-L38)
    17    class: GenerationOutcome                                        (L42-L58)
     5    class: TurnResult                                               (L62-L66)

   355  module: src/mlx_harmony/chat_utils.py                             (L1-L355)
     5    def: get_assistant_name                                         (L14-L18)
    18    def: get_truncate_limits                                        (L21-L38)
     5    def: truncate_text                                              (L41-L45)
    14    def: build_help_text                                            (L48-L61)
     9    def: render_hyperparameters                                     (L64-L72)
     4    def: normalize_set_command                                      (L75-L78)
    41    def: parse_hyperparameter_update                               (L81-L121)
    42    def: parse_command                                            (L124-L165)
    29    def: resolve_profile_and_prompt_config                        (L168-L196)
    31    def: resolve_max_context_tokens                               (L199-L229)
    23    def: detect_model_max_context_tokens                          (L232-L254)
    99    def: build_hyperparameters                                    (L257-L355)

   577  module: src/mlx_harmony/config.py                                 (L1-L577)
   152    class: PromptConfig                                            (L20-L171)
    11    def: _build_builtin_placeholders                              (L178-L188)
    24    def: _replace_angle_tokens                                    (L191-L214)
    20    def: _render_placeholders                                     (L217-L236)
     4    def: _maybe_render                                            (L239-L242)
     3    def: apply_placeholders                                       (L245-L247)
    15    def: _parse_deterministic_time                                (L250-L264)
   168    def: load_prompt_config                                       (L267-L434)
    73    def: parse_dialogue_text                                      (L440-L512)
    16    def: parse_dialogue_file                                      (L515-L530)
    18    def: load_profiles                                            (L536-L553)
    22    def: apply_performance_overrides                              (L556-L577)

    76  module: src/mlx_harmony/convert_dialogue.py                        (L1-L76)
    53    def: main                                                       (L20-L72)

   168  module: src/mlx_harmony/generate.py                               (L1-L168)
   152    def: main                                                      (L13-L164)

   478  module: src/mlx_harmony/generate_standalone.py                    (L1-L478)
    16    class: GenerationResponse                                       (L29-L44)
    13      def: __init__                                                 (L32-L44)
     9    def: _prompt_to_tokens                                          (L47-L55)
     6    def: _ensure_prompt_cache                                       (L58-L63)
    11    def: _resolve_sampler                                           (L66-L76)
     2      def: default_sampler                                          (L73-L74)
    60    def: _prefill_kv_cache                                         (L79-L138)
    21    def: _log_memory_stats                                        (L141-L161)
     6    def: _init_decoder                                            (L164-L169)
    25    def: _decode_next_token                                       (L172-L196)
   275    def: stream_generate                                          (L199-L473)

    26  module: src/mlx_harmony/generation/backend.py                      (L1-L26)
    19    class: ModelBackend                                              (L8-L26)
     9      def: prepare_prompt                                            (L9-L17)
     2      def: decode                                                   (L19-L20)
     2      def: get_tokenizer                                            (L22-L23)
     2      def: get_stop_tokens                                          (L25-L26)

     6  module: src/mlx_harmony/generation/backends/__init__.py             (L1-L6)

    44  module: src/mlx_harmony/generation/backends/gpt_oss_backend.py     (L1-L44)
    37    class: GPTOSSBackend                                             (L8-L44)
     7      def: __init__                                                  (L9-L15)
    19      def: prepare_prompt                                           (L17-L35)
     2      def: decode                                                   (L37-L38)
     2      def: get_tokenizer                                            (L40-L41)
     2      def: get_stop_tokens                                          (L43-L44)

    39  module: src/mlx_harmony/generation/backends/native_backend.py      (L1-L39)
    30    class: NativeBackend                                            (L10-L39)
     3      def: __init__                                                 (L11-L13)
    16      def: prepare_prompt                                           (L15-L30)
     2      def: decode                                                   (L32-L33)
     2      def: get_tokenizer                                            (L35-L36)
     2      def: get_stop_tokens                                          (L38-L39)

   581  module: src/mlx_harmony/generator.py                              (L1-L581)
   561    class: TokenGenerator                                          (L21-L581)
    75      def: __init__                                                (L30-L104)
     4      def: _is_gpt_oss_model                                      (L107-L110)
    17      def: _resolve_xtc_special_tokens                            (L112-L128)
    51      def: _resolve_end_token_ids                                 (L130-L180)
   290      def: generate                                               (L182-L471)
    28      def: _prepare_prompt                                        (L473-L500)
    12      def: render_prompt                                          (L502-L513)
    10      def: render_prompt_tokens                                   (L515-L524)
    13      def: _tokens_to_stop_strings                                (L526-L538)
    23      def: keepalive                                              (L540-L562)
    18      def: parse_messages_from_tokens                             (L564-L581)

    12  module: src/mlx_harmony/hyperparameters.py                         (L1-L12)
     5    def: resolve_param                                               (L8-L12)

   133  module: src/mlx_harmony/load_optimized.py                         (L1-L133)
    11    def: _prewarm_filesystem_cache                                  (L23-L33)
     5    def: _get_model_size_from_files                                 (L37-L41)
    16    def: prewarm_model_cache                                        (L44-L59)
    72    def: load_optimized                                            (L62-L133)

   418  module: src/mlx_harmony/loader.py                                 (L1-L418)
    35    def: _download_model                                            (L36-L70)
    22    def: _load_config                                               (L73-L94)
    27    def: _get_model_classes                                        (L97-L123)
    12    def: _load_weights                                            (L126-L137)
    52    def: _apply_quantization                                      (L140-L191)
    15    def: _get_model_size_from_index                               (L194-L208)
   208    def: load_model_standalone                                    (L211-L418)

    50  module: src/mlx_harmony/logging.py                                 (L1-L50)
     7    class: _MaxLevelFilter                                          (L10-L16)
     3      def: __init__                                                 (L11-L13)
     2      def: filter                                                   (L15-L16)
     4    def: configure_logging                                          (L19-L22)
     3    def: get_logger                                                 (L25-L27)
    21    def: configure_debug_file_logging                               (L30-L50)

    10  module: src/mlx_harmony/models/__init__.py                         (L1-L10)

    90  module: src/mlx_harmony/models/base.py                             (L1-L90)
    10    class: BaseModelArgs                                            (L16-L25)
     8      def: from_dict                                                (L18-L25)
    19    def: create_causal_mask                                         (L28-L46)
    11    def: create_attention_mask                                      (L49-L59)
     4    def: create_ssm_mask                                            (L62-L65)
    23    def: scaled_dot_product_attention                               (L68-L90)

   304  module: src/mlx_harmony/models/gpt_oss.py                         (L1-L304)
    16    class: ModelArgs                                                (L27-L42)
     8    def: mlx_topk                                                   (L46-L53)
    11    def: swiglu                                                     (L57-L67)
     6    class: SwiGLU                                                   (L70-L75)
     2      def: __init__                                                 (L71-L72)
     2      def: __call__                                                 (L74-L75)
    57    class: AttentionBlock                                          (L78-L134)
    34      def: __init__                                                (L79-L112)
    21      def: __call__                                               (L114-L134)
    29    class: MLPBlock                                               (L137-L165)
    17      def: __init__                                               (L138-L154)
    10      def: __call__                                               (L156-L165)
    21    class: TransformerBlock                                       (L168-L188)
     8      def: __init__                                               (L169-L176)
    11      def: __call__                                               (L178-L188)
    41    class: GptOssMoeModel                                         (L191-L231)
    15      def: __init__                                               (L192-L206)
    24      def: __call__                                               (L208-L231)
    71    class: Model                                                  (L234-L304)
     6      def: __init__                                               (L235-L240)
     2      def: __call__                                               (L242-L243)
    38      def: sanitize                                               (L245-L282)
     2      def: layers                                                 (L285-L286)
     7      def: quant_predicate                                        (L289-L295)
     4        def: predicate                                            (L290-L293)
     8      def: make_cache                                             (L297-L304)

   243  module: src/mlx_harmony/models/rope_utils.py                      (L1-L243)
    38    class: SuScaledRoPE                                             (L14-L51)
    25      def: __init__                                                 (L15-L39)
     4        def: default_scale                                          (L33-L36)
    11      def: __call__                                                 (L41-L51)
    52    class: Llama3RoPE                                              (L54-L105)
    34      def: __init__                                                 (L55-L88)
     5      def: extra_repr                                               (L90-L94)
    10      def: __call__                                                (L96-L105)
    68    class: YarnRoPE                                               (L108-L175)
    54      def: __init__                                               (L109-L162)
     7        def: yarn_find_correction_dim                             (L124-L130)
     4        def: yarn_find_correction_range                           (L132-L135)
     4        def: yarn_get_mscale                                      (L137-L140)
     8        def: yarn_linear_ramp_mask                                (L142-L149)
    12      def: __call__                                               (L164-L175)
    66    def: initialize_rope                                          (L178-L243)

   278  module: src/mlx_harmony/models/switch_layers.py                   (L1-L278)
     6    def: _gather_sort                                               (L14-L19)
     5    def: _scatter_unsort                                            (L22-L26)
    84    class: QuantizedSwitchLinear                                   (L29-L112)
    48      def: __init__                                                 (L30-L77)
     2      def: input_dims                                               (L80-L81)
     2      def: output_dims                                              (L84-L85)
     2      def: num_experts                                              (L88-L89)
    22      def: __call__                                                (L91-L112)
    58    class: SwitchLinear                                           (L115-L172)
    13      def: __init__                                               (L116-L128)
     2      def: input_dims                                             (L131-L132)
     2      def: output_dims                                            (L135-L136)
     2      def: num_experts                                            (L139-L140)
    10      def: __call__                                               (L142-L151)
    20      def: to_quantized                                           (L153-L172)
     2    def: swiglu                                                   (L176-L177)
     6    class: SwiGLU                                                 (L180-L185)
     2      def: __init__                                               (L181-L182)
     2      def: __call__                                               (L184-L185)
    40    class: SwitchGLU                                              (L188-L227)
    14      def: __init__                                               (L189-L202)
    24      def: __call__                                               (L204-L227)
    49    class: QuantizedSwitchGLU                                     (L230-L278)
    23      def: __init__                                               (L231-L253)
    24      def: __call__                                               (L255-L278)

   205  module: src/mlx_harmony/prompt_cache.py                           (L1-L205)
   196    class: PromptTokenCache                                        (L10-L205)
    10      def: __init__                                                 (L13-L22)
    10      def: reset                                                    (L24-L33)
    11      def: _common_suffix                                           (L35-L45)
    24      def: _ensure_base_tokens                                      (L47-L70)
    23      def: _message_token_ids                                       (L72-L94)
    37      def: rebuild                                                 (L96-L132)
    44      def: update_with_conversation                               (L134-L177)
    27      def: build_prompt_token_ids                                 (L179-L205)

    21  module: src/mlx_harmony/prompts/base.py                            (L1-L21)
    14    class: PromptRenderer                                            (L8-L21)
     5      def: render_prompt_text                                       (L11-L15)
     5      def: render_prompt_tokens                                     (L17-L21)

   183  module: src/mlx_harmony/prompts/harmony.py                        (L1-L183)
   164    class: HarmonyPromptRenderer                                   (L20-L183)
     4      def: __init__                                                 (L23-L26)
    20      def: render_prompt_text                                       (L28-L47)
    20      def: render_prompt_tokens                                     (L49-L68)
   114      def: _build_conversation                                     (L70-L183)

    30  module: src/mlx_harmony/prompts/native.py                          (L1-L30)
    25    class: NativePromptRenderer                                      (L6-L30)
     2      def: __init__                                                  (L9-L10)
    13      def: render_prompt_text                                       (L12-L24)
     5      def: render_prompt_tokens                                     (L26-L30)

    78  module: src/mlx_harmony/repetition_tokens.py                       (L1-L78)
    11    class: TokenRepetitionConfig                                     (L9-L19)
    57    class: TokenRepetitionDetector                                  (L22-L78)
     9      def: __init__                                                 (L23-L31)
    46      def: update                                                   (L33-L78)

    25  module: src/mlx_harmony/runtime/context.py                         (L1-L25)
    14    class: RunContext                                               (L12-L25)

    28  module: src/mlx_harmony/runtime/metrics.py                         (L1-L28)
    10    class: TimingStats                                              (L10-L19)
     3      def: add                                                      (L14-L16)
     2      def: snapshot                                                 (L18-L19)
     6    def: timer                                                      (L23-L28)

    17  module: src/mlx_harmony/runtime/sampler.py                         (L1-L17)
     5    class: SamplerProtocol                                           (L6-L10)
     2      def: __call__                                                  (L9-L10)
     5    class: LogitsProcessorProtocol                                  (L13-L17)
     2      def: __call__                                                 (L16-L17)

    19  module: src/mlx_harmony/runtime/tokenizer.py                       (L1-L19)
    14    class: TokenizerProtocol                                         (L6-L19)
     3      def: encode                                                    (L9-L11)
     3      def: decode                                                   (L13-L15)
     3      def: decode_token                                             (L17-L19)

   464  module: src/mlx_harmony/sampling.py                               (L1-L464)
    15    def: sample_temperature                                         (L15-L29)
    29    def: sample_top_k                                               (L32-L60)
    68    def: sample_top_p                                              (L63-L130)
    24    def: sample_min_p                                             (L133-L156)
    57    def: sample_xtc                                               (L159-L215)
    54    def: make_sampler                                             (L218-L271)
    23      def: sampler                                                (L247-L269)
    75    def: repetition_penalty_processor                             (L274-L348)
    58      def: processor                                              (L288-L345)
    26    def: logit_bias_processor                                     (L351-L376)
     7      def: processor                                              (L367-L373)
    27    def: make_logits_processors                                   (L379-L405)
    12    def: build_logits_processors                                  (L408-L419)
    12    def: apply_logits_processors                                  (L422-L433)
    15    def: fuse_logits_processors                                   (L436-L450)
     4      def: fused                                                  (L445-L448)
    12    def: get_repetition_window_size                               (L453-L464)

   151  module: src/mlx_harmony/server.py                                 (L1-L151)
     3    class: ChatMessage                                              (L18-L20)
    14    class: ChatRequest                                              (L23-L36)
    13    def: _get_generator                                             (L46-L58)
    80    def: chat_completions                                          (L62-L141)
     4    def: main                                                     (L144-L147)

   580  module: src/mlx_harmony/tokenizer_native.py                       (L1-L580)
    56    class: SimpleStreamingDetokenizer                               (L20-L75)
     4      def: __init__                                                 (L23-L26)
     6      def: reset                                                    (L28-L33)
    32      def: add_token                                                (L35-L66)
     8      def: finalize                                                 (L68-L75)
   390    class: ByteLevelBPETokenizer                                   (L78-L467)
    46      def: __init__                                                (L81-L126)
    26      def: _make_byte_encoder                                     (L129-L154)
     3      def: _byte_encode                                           (L156-L158)
    15      def: _byte_decode                                           (L160-L174)
    51      def: _apply_bpe                                             (L176-L226)
    62      def: encode                                                 (L228-L289)
    73      def: decode                                                 (L291-L363)
     2      def: decode_token                                           (L365-L366)
    61      def: apply_chat_template                                    (L368-L428)
     3      def: vocab_size                                             (L431-L433)
     3      def: eos_token_id                                           (L436-L438)
     3      def: eos_token_id                                           (L441-L443)
     3      def: bos_token_id                                           (L446-L448)
     3      def: bos_token_id                                           (L451-L453)
     3      def: pad_token_id                                           (L456-L458)
     3      def: pad_token_id                                           (L461-L463)
     3      def: get_vocab                                              (L465-L467)
   111    def: load_tokenizer_native                                    (L470-L580)

   121  module: src/mlx_harmony/tools/__init__.py                         (L1-L121)
    45    def: parse_tool_calls_from_messages                             (L19-L63)
    17    def: execute_tool_call                                          (L66-L82)
    10    def: _execute_browser_tool                                      (L85-L94)
    10    def: _execute_python_tool                                      (L97-L106)
    10    def: _execute_apply_patch_tool                                (L109-L118)

    32  module: src/mlx_harmony/tools/registry.py                          (L1-L32)
    25    def: get_tools_for_model                                         (L8-L32)

    99  module: src/mlx_harmony/tools/runner.py                            (L1-L99)
    74    def: run_tools_if_requested                                     (L12-L85)
    12    def: has_tool_calls                                             (L88-L99)

    25  module: src/mlx_harmony/tools/types.py                             (L1-L25)
     7    class: ToolConfig                                                (L9-L15)
     8    class: ToolCall                                                 (L18-L25)
