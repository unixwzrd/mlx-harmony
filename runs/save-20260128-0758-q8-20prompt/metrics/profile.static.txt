STATIC METRICS (AST-derived)

Top cyclomatic-ish complexity (higher = more branching):
    50  /Users/mps/projects/AI-PROJECTS/mlx-harmony/src/mlx_harmony/generate_standalone.py:201  stream_generate
    49  /Users/mps/projects/AI-PROJECTS/mlx-harmony/src/mlx_harmony/chat_harmony.py:29  parse_harmony_response
    49  /Users/mps/projects/AI-PROJECTS/mlx-harmony/src/mlx_harmony/generator.py:183  TokenGenerator.generate
    34  /Users/mps/projects/AI-PROJECTS/mlx-harmony/src/mlx_harmony/prompts/harmony.py:70  HarmonyPromptRenderer._build_conversation
    31  /Users/mps/projects/AI-PROJECTS/mlx-harmony/src/mlx_harmony/chat_turn.py:17  run_chat_turn
    30  /Users/mps/projects/AI-PROJECTS/mlx-harmony/src/mlx_harmony/chat_prompt.py:66  truncate_conversation_for_context
    28  /Users/mps/projects/AI-PROJECTS/mlx-harmony/src/mlx_harmony/tokenizer_native.py:470  load_tokenizer_native
    27  /Users/mps/projects/AI-PROJECTS/mlx-harmony/src/mlx_harmony/chat.py:75  main
    27  /Users/mps/projects/AI-PROJECTS/mlx-harmony/src/mlx_harmony/chat_attempt.py:218  _detect_text_repetition
    21  /Users/mps/projects/AI-PROJECTS/mlx-harmony/src/mlx_harmony/config.py:267  load_prompt_config
    21  /Users/mps/projects/AI-PROJECTS/mlx-harmony/src/mlx_harmony/loader.py:211  load_model_standalone
    19  /Users/mps/projects/AI-PROJECTS/mlx-harmony/src/mlx_harmony/chat_migration.py:25  _ensure_metadata_fields
    18  /Users/mps/projects/AI-PROJECTS/mlx-harmony/src/mlx_harmony/chat_retry.py:8  build_retry_plan
    18  /Users/mps/projects/AI-PROJECTS/mlx-harmony/src/mlx_harmony/repetition_tokens.py:33  TokenRepetitionDetector.update
    17  /Users/mps/projects/AI-PROJECTS/mlx-harmony/src/mlx_harmony/generate_standalone.py:81  _prefill_kv_cache
    17  /Users/mps/projects/AI-PROJECTS/mlx-harmony/src/mlx_harmony/generator.py:131  TokenGenerator._resolve_end_token_ids
    16  /Users/mps/projects/AI-PROJECTS/mlx-harmony/src/mlx_harmony/chat_bootstrap.py:47  bootstrap_chat
    15  /Users/mps/projects/AI-PROJECTS/mlx-harmony/src/mlx_harmony/chat_history.py:24  normalize_dir_path
    15  /Users/mps/projects/AI-PROJECTS/mlx-harmony/src/mlx_harmony/tools/runner.py:12  run_tools_if_requested
    14  /Users/mps/projects/AI-PROJECTS/mlx-harmony/src/mlx_harmony/chat_attempt.py:15  run_generation_attempt
    14  /Users/mps/projects/AI-PROJECTS/mlx-harmony/src/mlx_harmony/chat_generation.py:10  stream_generation
    14  /Users/mps/projects/AI-PROJECTS/mlx-harmony/src/mlx_harmony/chat_history.py:120  resolve_chat_paths
    14  /Users/mps/projects/AI-PROJECTS/mlx-harmony/src/mlx_harmony/chat_migration.py:175  validate_chat_container
    14  /Users/mps/projects/AI-PROJECTS/mlx-harmony/src/mlx_harmony/config.py:440  parse_dialogue_text
    14  /Users/mps/projects/AI-PROJECTS/mlx-harmony/src/mlx_harmony/models/gpt_oss.py:245  Model.sanitize
    14  /Users/mps/projects/AI-PROJECTS/mlx-harmony/src/mlx_harmony/tools/__init__.py:19  parse_tool_calls_from_messages
    12  /Users/mps/projects/AI-PROJECTS/mlx-harmony/src/mlx_harmony/chat_history.py:204  restore_chat_metadata
    12  /Users/mps/projects/AI-PROJECTS/mlx-harmony/src/mlx_harmony/sampling.py:159  sample_xtc
    12  /Users/mps/projects/AI-PROJECTS/mlx-harmony/src/mlx_harmony/tokenizer_native.py:291  ByteLevelBPETokenizer.decode
    12  /Users/mps/projects/AI-PROJECTS/mlx-harmony/src/mlx_harmony/tokenizer_native.py:368  ByteLevelBPETokenizer.apply_chat_template
    11  /Users/mps/projects/AI-PROJECTS/mlx-harmony/src/mlx_harmony/chat_io.py:150  load_conversation
    11  /Users/mps/projects/AI-PROJECTS/mlx-harmony/src/mlx_harmony/chat_migration.py:130  migrate_chat_data
    11  /Users/mps/projects/AI-PROJECTS/mlx-harmony/src/mlx_harmony/chat_migration.py:249  main
    11  /Users/mps/projects/AI-PROJECTS/mlx-harmony/src/mlx_harmony/chat_utils.py:199  resolve_max_context_tokens
    11  /Users/mps/projects/AI-PROJECTS/mlx-harmony/src/mlx_harmony/generator.py:478  TokenGenerator._prepare_prompt
    10  /Users/mps/projects/AI-PROJECTS/mlx-harmony/src/mlx_harmony/cache.py:243  RotatingKVCache.make_mask
    10  /Users/mps/projects/AI-PROJECTS/mlx-harmony/src/mlx_harmony/chat_attempt.py:290  _detect_token_repetition
    10  /Users/mps/projects/AI-PROJECTS/mlx-harmony/src/mlx_harmony/chat_attempt.py:311  _looks_complete_response
    10  /Users/mps/projects/AI-PROJECTS/mlx-harmony/src/mlx_harmony/chat_io.py:68  save_conversation
    10  /Users/mps/projects/AI-PROJECTS/mlx-harmony/src/mlx_harmony/chat_utils.py:257  build_hyperparameters

Top fan-out (unique callees; candidates for splitting/decoupling):
    35  /Users/mps/projects/AI-PROJECTS/mlx-harmony/src/mlx_harmony/generate_standalone.py:201  stream_generate
    32  /Users/mps/projects/AI-PROJECTS/mlx-harmony/src/mlx_harmony/loader.py:211  load_model_standalone
    30  /Users/mps/projects/AI-PROJECTS/mlx-harmony/src/mlx_harmony/chat_harmony.py:29  parse_harmony_response
    26  /Users/mps/projects/AI-PROJECTS/mlx-harmony/src/mlx_harmony/chat_turn.py:17  run_chat_turn
    24  /Users/mps/projects/AI-PROJECTS/mlx-harmony/src/mlx_harmony/chat.py:75  main
    24  /Users/mps/projects/AI-PROJECTS/mlx-harmony/src/mlx_harmony/chat_attempt.py:15  run_generation_attempt
    24  /Users/mps/projects/AI-PROJECTS/mlx-harmony/src/mlx_harmony/generator.py:183  TokenGenerator.generate
    23  /Users/mps/projects/AI-PROJECTS/mlx-harmony/src/mlx_harmony/prompts/harmony.py:70  HarmonyPromptRenderer._build_conversation
    22  /Users/mps/projects/AI-PROJECTS/mlx-harmony/src/mlx_harmony/config.py:267  load_prompt_config
    21  /Users/mps/projects/AI-PROJECTS/mlx-harmony/src/mlx_harmony/chat_bootstrap.py:47  bootstrap_chat
    18  /Users/mps/projects/AI-PROJECTS/mlx-harmony/src/mlx_harmony/chat_io.py:68  save_conversation
    17  /Users/mps/projects/AI-PROJECTS/mlx-harmony/src/mlx_harmony/chat_attempt.py:218  _detect_text_repetition
    17  /Users/mps/projects/AI-PROJECTS/mlx-harmony/src/mlx_harmony/tokenizer_native.py:470  load_tokenizer_native
    15  /Users/mps/projects/AI-PROJECTS/mlx-harmony/src/mlx_harmony/chat_prompt.py:66  truncate_conversation_for_context
    14  /Users/mps/projects/AI-PROJECTS/mlx-harmony/src/mlx_harmony/generate.py:13  main
    14  /Users/mps/projects/AI-PROJECTS/mlx-harmony/src/mlx_harmony/sampling.py:288  processor
    13  /Users/mps/projects/AI-PROJECTS/mlx-harmony/src/mlx_harmony/chat_migration.py:249  main
    13  /Users/mps/projects/AI-PROJECTS/mlx-harmony/src/mlx_harmony/convert_dialogue.py:20  main
    13  /Users/mps/projects/AI-PROJECTS/mlx-harmony/src/mlx_harmony/generator.py:131  TokenGenerator._resolve_end_token_ids
    13  /Users/mps/projects/AI-PROJECTS/mlx-harmony/src/mlx_harmony/sampling.py:63  sample_top_p
    13  /Users/mps/projects/AI-PROJECTS/mlx-harmony/src/mlx_harmony/tools/runner.py:12  run_tools_if_requested
    12  /Users/mps/projects/AI-PROJECTS/mlx-harmony/src/mlx_harmony/chat_io.py:150  load_conversation
    12  /Users/mps/projects/AI-PROJECTS/mlx-harmony/src/mlx_harmony/chat_migration.py:175  validate_chat_container
    12  /Users/mps/projects/AI-PROJECTS/mlx-harmony/src/mlx_harmony/config.py:440  parse_dialogue_text
    12  /Users/mps/projects/AI-PROJECTS/mlx-harmony/src/mlx_harmony/server.py:62  chat_completions
    11  /Users/mps/projects/AI-PROJECTS/mlx-harmony/src/mlx_harmony/chat_generation.py:10  stream_generation
    11  /Users/mps/projects/AI-PROJECTS/mlx-harmony/src/mlx_harmony/chat_migration.py:130  migrate_chat_data
    11  /Users/mps/projects/AI-PROJECTS/mlx-harmony/src/mlx_harmony/chat_utils.py:124  parse_command
    11  /Users/mps/projects/AI-PROJECTS/mlx-harmony/src/mlx_harmony/logging.py:30  configure_debug_file_logging
    11  /Users/mps/projects/AI-PROJECTS/mlx-harmony/src/mlx_harmony/repetition_tokens.py:33  TokenRepetitionDetector.update
    10  /Users/mps/projects/AI-PROJECTS/mlx-harmony/src/mlx_harmony/chat_history.py:120  resolve_chat_paths
    10  /Users/mps/projects/AI-PROJECTS/mlx-harmony/src/mlx_harmony/chat_utils.py:232  detect_model_max_context_tokens
    10  /Users/mps/projects/AI-PROJECTS/mlx-harmony/src/mlx_harmony/models/gpt_oss.py:114  AttentionBlock.__call__
     9  /Users/mps/projects/AI-PROJECTS/mlx-harmony/src/mlx_harmony/chat_history.py:320  load_chat_session
     9  /Users/mps/projects/AI-PROJECTS/mlx-harmony/src/mlx_harmony/generator.py:30  TokenGenerator.__init__
     9  /Users/mps/projects/AI-PROJECTS/mlx-harmony/src/mlx_harmony/models/switch_layers.py:204  SwitchGLU.__call__
     9  /Users/mps/projects/AI-PROJECTS/mlx-harmony/src/mlx_harmony/models/switch_layers.py:255  QuantizedSwitchGLU.__call__
     9  /Users/mps/projects/AI-PROJECTS/mlx-harmony/src/mlx_harmony/tokenizer_native.py:291  ByteLevelBPETokenizer.decode
     8  /Users/mps/projects/AI-PROJECTS/mlx-harmony/src/mlx_harmony/chat_history.py:523  display_resume_message
     8  /Users/mps/projects/AI-PROJECTS/mlx-harmony/src/mlx_harmony/chat_io.py:39  read_user_input

Top fan-in (many callers; ‘central’ APIs worth stabilizing):
    15  /Users/mps/projects/AI-PROJECTS/mlx-harmony/src/mlx_harmony/cache.py:24  KVCache.__init__
    15  /Users/mps/projects/AI-PROJECTS/mlx-harmony/src/mlx_harmony/cache.py:131  RotatingKVCache.__init__
    15  /Users/mps/projects/AI-PROJECTS/mlx-harmony/src/mlx_harmony/generate_standalone.py:32  GenerationResponse.__init__
    15  /Users/mps/projects/AI-PROJECTS/mlx-harmony/src/mlx_harmony/generation/backends/gpt_oss_backend.py:9  GPTOSSBackend.__init__
    15  /Users/mps/projects/AI-PROJECTS/mlx-harmony/src/mlx_harmony/generation/backends/native_backend.py:11  NativeBackend.__init__
    15  /Users/mps/projects/AI-PROJECTS/mlx-harmony/src/mlx_harmony/generator.py:30  TokenGenerator.__init__
    15  /Users/mps/projects/AI-PROJECTS/mlx-harmony/src/mlx_harmony/logging.py:11  _MaxLevelFilter.__init__
    15  /Users/mps/projects/AI-PROJECTS/mlx-harmony/src/mlx_harmony/models/gpt_oss.py:71  SwiGLU.__init__
    15  /Users/mps/projects/AI-PROJECTS/mlx-harmony/src/mlx_harmony/models/gpt_oss.py:79  AttentionBlock.__init__
    15  /Users/mps/projects/AI-PROJECTS/mlx-harmony/src/mlx_harmony/models/gpt_oss.py:138  MLPBlock.__init__
    15  /Users/mps/projects/AI-PROJECTS/mlx-harmony/src/mlx_harmony/models/gpt_oss.py:169  TransformerBlock.__init__
    15  /Users/mps/projects/AI-PROJECTS/mlx-harmony/src/mlx_harmony/models/gpt_oss.py:192  GptOssMoeModel.__init__
    15  /Users/mps/projects/AI-PROJECTS/mlx-harmony/src/mlx_harmony/models/gpt_oss.py:235  Model.__init__
    15  /Users/mps/projects/AI-PROJECTS/mlx-harmony/src/mlx_harmony/models/rope_utils.py:15  SuScaledRoPE.__init__
    15  /Users/mps/projects/AI-PROJECTS/mlx-harmony/src/mlx_harmony/models/rope_utils.py:55  Llama3RoPE.__init__
    15  /Users/mps/projects/AI-PROJECTS/mlx-harmony/src/mlx_harmony/models/rope_utils.py:109  YarnRoPE.__init__
    15  /Users/mps/projects/AI-PROJECTS/mlx-harmony/src/mlx_harmony/models/switch_layers.py:30  QuantizedSwitchLinear.__init__
    15  /Users/mps/projects/AI-PROJECTS/mlx-harmony/src/mlx_harmony/models/switch_layers.py:116  SwitchLinear.__init__
    15  /Users/mps/projects/AI-PROJECTS/mlx-harmony/src/mlx_harmony/models/switch_layers.py:181  SwiGLU.__init__
    15  /Users/mps/projects/AI-PROJECTS/mlx-harmony/src/mlx_harmony/models/switch_layers.py:189  SwitchGLU.__init__
    15  /Users/mps/projects/AI-PROJECTS/mlx-harmony/src/mlx_harmony/models/switch_layers.py:231  QuantizedSwitchGLU.__init__
    15  /Users/mps/projects/AI-PROJECTS/mlx-harmony/src/mlx_harmony/prompt_cache.py:13  PromptTokenCache.__init__
    15  /Users/mps/projects/AI-PROJECTS/mlx-harmony/src/mlx_harmony/prompts/harmony.py:23  HarmonyPromptRenderer.__init__
    15  /Users/mps/projects/AI-PROJECTS/mlx-harmony/src/mlx_harmony/prompts/native.py:9  NativePromptRenderer.__init__
    15  /Users/mps/projects/AI-PROJECTS/mlx-harmony/src/mlx_harmony/repetition_tokens.py:23  TokenRepetitionDetector.__init__
    15  /Users/mps/projects/AI-PROJECTS/mlx-harmony/src/mlx_harmony/tokenizer_native.py:23  SimpleStreamingDetokenizer.__init__
    15  /Users/mps/projects/AI-PROJECTS/mlx-harmony/src/mlx_harmony/tokenizer_native.py:81  ByteLevelBPETokenizer.__init__
     9  /Users/mps/projects/AI-PROJECTS/mlx-harmony/src/mlx_harmony/chat_history.py:55  make_timestamp
     5  /Users/mps/projects/AI-PROJECTS/mlx-harmony/src/mlx_harmony/chat_history.py:64  make_message_id
     5  /Users/mps/projects/AI-PROJECTS/mlx-harmony/src/mlx_harmony/chat_history.py:255  _write_debug_block
     4  /Users/mps/projects/AI-PROJECTS/mlx-harmony/src/mlx_harmony/chat_render.py:14  display_assistant
     4  /Users/mps/projects/AI-PROJECTS/mlx-harmony/src/mlx_harmony/config.py:267  load_prompt_config
     3  /Users/mps/projects/AI-PROJECTS/mlx-harmony/src/mlx_harmony/chat_history.py:74  find_last_hyperparameters
     3  /Users/mps/projects/AI-PROJECTS/mlx-harmony/src/mlx_harmony/chat_migration.py:130  migrate_chat_data
     3  /Users/mps/projects/AI-PROJECTS/mlx-harmony/src/mlx_harmony/chat_utils.py:41  truncate_text
     3  /Users/mps/projects/AI-PROJECTS/mlx-harmony/src/mlx_harmony/config.py:536  load_profiles
     2  /Users/mps/projects/AI-PROJECTS/mlx-harmony/src/mlx_harmony/cache.py:310  make_prompt_cache
     2  /Users/mps/projects/AI-PROJECTS/mlx-harmony/src/mlx_harmony/chat_generation.py:10  stream_generation
     2  /Users/mps/projects/AI-PROJECTS/mlx-harmony/src/mlx_harmony/chat_history.py:15  normalize_chat_name
     2  /Users/mps/projects/AI-PROJECTS/mlx-harmony/src/mlx_harmony/chat_history.py:69  make_chat_id
